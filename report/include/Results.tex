\chapter{Results}

% Somewhat done. Patrik:
% This is relevant text, but should perhaps be split into proper results, and
% comments / discussion.  Concretely, what is before "This is good" are clearly
% results, but then you switch to "discussion" in the middle of a paragraph.
% Before that I would have expected some measure of how much of the SDP
% implementation in IdrisLibs (if any) can be translated at this stage [the
% planning report explicitly mentioned this - the (half-time) report should
% therefore relate to that].
%
% This is somewhat done.

% DONE For over till officiella mallen.
% TODO Beskriv och visa program som faktiskt kor och g[r igenom `ita`
% Med faktiska kod exempel.
% TODO Testa pa idrisLibs vilka filer som faktiskt inte kraschar och vad den
% kraschar pa. Testa alla filer i IdrisLibs/SequentialDesicionProblems/ och se
% vilka som fungerar och inte fungerar.
% TODO Hitta en fil med beroenden som fungerar fran idrislibs.


We have constructed a transpiler from a subset of Idris to Agda. It handles the
expression language, type signatures and data declarations.  It fails for
implicit arguments, which have to be declared in Agda but not in Idris. The
transpiler re-uses both the Idris parser and the Agda pretty-printer from their
main implementations.

% TODO Maybe split into proper results/discussion.
Currently it is not possible to run the transpiler on most parts of IdrisLibs.
This is due to some bugs with relative imports when loading modules. The
transpiler is not searching for modules in the same places as the main Idris
compiler.

We have made some progress, but not as much as planned. It has taken quite some
time working with and around the existing code.  Real-life implementations make
a lot of practical considerations which complicates the code a lot, and are not
relevant for this project.

% We have developed a tool to translate simple Idris programs into Agda. It works
% for a subset of Idris, namely:

The problem of building both project with the same version of GHC and
dependencies took time. It was a manual process of comparing cabal-files and
trying to find versions of dependencies which matches both. And in some cases
change one project to use a more recent version of a dependency with a updated
interface. Idris also uses a custom build process which need some revision to
work in a new folder structure.\todo{Update to current progress}

% Idris uses a custom build process which was a pain to use with a different
% folder structure. Since we wanted to pull in both Idris and Agda as `git`
% submodules in our repo we needed to change the folder structure and the build
% process. The was maybe not worth the effort.

For programs which only use a subset of the Idris\todo{Specify which subset}
language it is possible to transpile a program, which then type checks in Agda
and finally can the compiled Agda output be run. Manual inspection of the type
signature matches the expected for the programs we have tested. We have
however, not done any comparison of the run time results. But from the types
the translation seem correct.\todo{Remove duplication and false statements}

The transpiler works but does not handle a large enough subset of Idris to be
able to compile substantial programs. Therefore it is hard to test the
transpiler thoroughly.\todo{This is not true. It handles large programs just
not many language features.}


% TODO Remove everything which is not true in this paragraph.
The verification level we have done is manual inspection of the type
signatures. Further verification is not possible without implementing
dependency chasing and providing the Idris standard library in Agda. Both tasks
are large software engineering tasks which take a lot of time and effort. But
they are not interesting from an academic standpoint.

However it would be intresting to try to transpile the Idris standard library,
most of it is implemented in Idris itself so it is possible. But it uses many
language features which we have not implemented yet.
% Which is expexted since it is developed by the Idris maintainers.

The development process in the beginning the process was to run the transpiler
, then try to load the program in Agda and see if it compiles.  Then we would
manually fix the program until it compiles.  After that we changed the
transpiler to perform the same change we just did manually.

% Implicit arguments are only known and calculated in the elaboration step of
% Idris compilation. There for it is hard to translate them after only parsing.

% TODO Write this better
% Somewhat done Patrik:
% Some overlap
The transpiler does not handle implicit arguments yet.\todo{This should now be
elaborated in several paragraphs}
% Agda requires more explicit definitions, implicit arguments have to be defined.
% Idris automatically considers all lower case variables in type signatures to be
% a implicit variable.

Since the implicit arguments in Idris are elaborated in the Type-checker we can
not use the parser output to reconstruct them.
Only after Idris is compiled to a lower level intermediate
language called \texttt{tt\_elab} the type-checking and elaboration is
run.\todo{Remove this and write what actually works today and what does not.}

\todo{Since this is done now, the language should be changed.}
\todo{And moved to methods}
Therefore we need to run the elaboration and then extract the implicit
arguments from the intermediate representation before translating them to
Agda.  We are going to do this in a pre-precessing step before the translation,
we translate the intermediate back into the high level AST Idris. This makes it
possible the then just use the main transpiler.  This has the side effect of
making that translation useful for a Idris automatic refactoring tool. It is
often useful to change between implicit and explicit arguments when developing
a dependently typed program.

% This was used to guide and prioritize the implementation of the main tool. For
% the most part it matches our intuitive guess. But it gives us a better argument
% for that the transpiler is useful, even though it is unfinished.

% \subsection{Implementation difficulties}
% As expected we ran it to a lot of non project related difficulties when trying
% to reuse existing Agda and Idris sources.

% Something something about the crazy Idris implementation with a big state
% monad used everywhere. It is almost an imperative program,
% just written in Haskell.

% The next version of Idris is developed from scratch in a new project, and some
% of the reasons for that is the current implantation, and the difficulties in
% working with it.

% Just trying to find the internal interface of the Idris parser took a long
% time.
